trigger:
  branches:
    include:
    - releases/*

jobs:
- job: EvaluationJob
  timeoutInMinutes: 300
  cancelTimeoutInMinutes: 2

  pool:
    vmImage: 'Ubuntu-20.04'

  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.7'
  - task: Cache@2
    inputs:
      key: 'python | "$(Agent.OS)" | requirements.txt'
      restoreKeys: |
        python | "$(Agent.OS)"
        python
      path: $(PIP_CACHE_DIR)
    displayName: Cache pip packages
  - script: |
      set -euox pipefail
      python -m pip install --upgrade pip
      pip install -r requirements.txt
    displayName: 'Install dependencies'

  - bash: |
      set -euox pipefail
      echo Login Azure Account
      az login -t $(sptenent) --service-principal -u $(spidentity) --password $(spsecret)
      az account set --subscription $(subscriptionid)
    displayName: 'Azure Login'

  - bash: |
      set -euox pipefail
      cd src/common/evaluation/QA
      python auth.py -sid $(subscriptionid) -rg $(RESOURCE_GROUP) -wn $(WORKSPACE_NAME)
    displayName: 'Saving Workspace Config'

  - bash: |
      set -euox pipefail
      cd src/common/evaluation/QA/eval-depthmap-height
      echo Executing eval_notebook.ipynb
      papermill eval_notebook.ipynb depthmap-height_output.ipynb --log-output --no-progress-bar -k python3
      jupyter nbconvert --to html depthmap-height_output.ipynb
      ls -l
    displayName: 'Depthmap Height Model Evaluation'

  - bash: |
      set -euox pipefail
      cd src/common/evaluation/QA/eval-standardisation-test
      echo Executing eval_notebook.ipynb
      papermill eval_notebook.ipynb standardisation-test_output.ipynb --log-output --no-progress-bar -k python3
      jupyter nbconvert --to html standardisation-test_output.ipynb
      ls -l
    displayName: 'Standardisation Test Model Evaluation'

  - task: CopyFiles@2
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)'
      Contents: |
        src/common/evaluation/QA/eval-depthmap-height/depthmap-height_output.html
        src/common/evaluation/QA/eval-depthmap-height/*.csv
        src/common/evaluation/QA/eval-standardisation-test/standardisation-test_output.html
        src/common/evaluation/QA/eval-standardisation-test/*.csv
      TargetFolder: '$(Build.ArtifactStagingDirectory)'
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'

  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: '$(Build.ArtifactStagingDirectory)'
      artifact: 'Output Notebook'
      publishLocation: 'pipeline'
    displayName: 'Publish Results and Output Notebook'

  - bash: |
      az logout
    displayName: 'Azure Logout'
